/**

 导入文件夹里面的所有JS
 Author : wxzhang

 */

const fs = require("fs")
const path = require("path")

/**
 * 导入文件夹下的所有js
 * @param folder
 * @param limitFor 声明限制的文件扩展名称,多个扩展名使用,分割，如"js,json"，默认只导入js文件
 */
function requireFolder(folder, limitFor="js"){
    let modules=[]
    limitFor=limitFor.split(",").map((item)=>{return item.toLowerCase().charAt(0)==="." ? item.toLowerCase() : "."+item.toLowerCase()})
    if(fs.existsSync(folder)){
        for(let module of fs.readdirSync(folder)){
            try{
                let modfile=path.join(folder,module)
                if(limitFor.includes(path.extname(modfile))){
                    try{
                        modules.push(require(modfile))
                    }catch (e) {
                        logger.warn(_("Cannot require module <{name}>:{err}").params(module,e.stack))
                    }
                }
            }catch(e){
                logger.warn(_("Cannot require module from {name}:{err}").params(modfile,e.stack))
            }
        }
    }
    return modules
}

/**
 * 重新载入模块
 * 重新载入模块
 */
function hotRequire(module){
    let modulePath = require.resolve(module)
    require.cache[modulePath] = null
    return require(module)
}

function flexibleRequire(path) {
    // return require('a/b/c')
    // 如果 require('a/b/c') throw Error
    // 则 return require('a/b').c
    try {
        return require(path);
    } catch (e) {
	    let modulePath = (path || '').split('/');      // [a, b, c]
        let subModuleName = modulePath.splice(-1, 1);  // [c]
        modulePath = modulePath.join('/');             // [a, b] => a/b
        subModuleName = subModuleName[0];              // c
        if (modulePath) {
            try {
                let module = require(modulePath)[subModuleName]; // require(a/b).c
                if (module) return module;
                else throw e;
            } catch (_e) {
                if (_e.code === 'MODULE_NOT_FOUND') throw e;
                else throw _e;
            }
        }
        else throw e;
    }
}


module.exports={
    requireFolder,
    hotRequire,
    flexibleRequire
}


