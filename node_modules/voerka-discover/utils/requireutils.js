/**

 Importar todo el JS en la carpeta
 Autor: wxzhang

 */

const fs = require("fs")
const path = require("path")

/**
 * Importar todos los js en la carpeta
 * @param folder
 * @param limitFor Declarar nombres de extensiones de archivo restringidos, usar múltiples extensiones, dividir, como "js,json", de manera predeterminada solo se importan archivos js
 */
function requireFolder(folder, limitFor="js"){
    let modules=[]
    limitFor=limitFor.split(",").map((item)=>{return item.toLowerCase().charAt(0)==="." ? item.toLowerCase() : "."+item.toLowerCase()})
    if(fs.existsSync(folder)){
        for(let module of fs.readdirSync(folder)){
            try{
                let modfile=path.join(folder,module)
                if(limitFor.includes(path.extname(modfile))){
                    try{
                        modules.push(require(modfile))
                    }catch (e) {
                        logger.warn(_("Cannot require module <{name}>:{err}").params(module,e.stack))
                    }
                }
            }catch(e){
                logger.warn(_("Cannot require module from {name}:{err}").params(modfile,e.stack))
            }
        }
    }
    return modules
}

/**
* Recargar el módulo
 * Recargar el módulo
 */
function hotRequire(module){
    let modulePath = require.resolve(module)
    require.cache[modulePath] = null
    return require(module)
}

function flexibleRequire(path) {
    // devolver require('a/b/c')
    // si require('a/b/c') arroja Error
    // luego devuelve require('a/b').c
    try {
        return require(path);
    } catch (e) {
	    let modulePath = (path || '').split('/');      // [a, b, c]
        let subModuleName = modulePath.splice(-1, 1);  // [c]
        modulePath = modulePath.join('/');             // [a, b] => a/b
        subModuleName = subModuleName[0];              // c
        if (modulePath) {
            try {
                let module = require(modulePath)[subModuleName]; // require(a/b).c
                if (module) return module;
                else throw e;
            } catch (_e) {
                if (_e.code === 'MODULE_NOT_FOUND') throw e;
                else throw _e;
            }
        }
        else throw e;
    }
}


module.exports={
    requireFolder,
    hotRequire,
    flexibleRequire
}


